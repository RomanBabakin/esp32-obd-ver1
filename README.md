# ESP32-OBD-Gauge Ver. 1

## Project Overview

This project is a custom OBD-II (On-Board Diagnostics) and vehicle dynamics display system built using an ESP32 microcontroller. It reads real-time data from a car's CAN bus and an MPU6050 accelerometer, presenting it on a TFT display with a user interface created in SquareLine Studio. This is a personal project developed for in-car use.

The primary interface language in the UI is Russian.

## Features

* **Real-time Data Display:**
    * **OBD-II Data:** Engine RPM, Oil Temperature, Coolant Temperature, Intake Air Temperature, Boost Pressure (kPA and relative Bars), Vehicle Speed.
    * **Accelerometer Data:** Lateral (X-axis on display) and Longitudinal (Y-axis on display) G-forces.
    * **Calculated Data:** Current Gear (based on RPM and speed for specific vehicles like Clio).
* **Multiple Screens:** User-navigable screens to display different sets of data, designed with LVGL and SquareLine Studio.
    * Screen 1: Temperatures (Coolant, Oil, Intake Air)
    * Screen 2: Boost Pressure (numerical and bar graph)
    * Screen 3: Engine RPM (numerical and arc gauge)
    * Screen 4: G-Force Meter (2D pointer display)
    * Screen 5: Calculated Gear and RPM-based background visualizer
* **Audible Alerts:** Buzzer for warnings and alarms based on coolant and oil temperature thresholds.
* **Visual Alerts & Status:**
    * On-screen visual cues for high temperatures.
    * NeoPixel LED for CAN bus connection status (Red at startup, Blue while attempting, Green when connected).
* **Hardware Interfacing:**
    * CAN bus interface for OBD-II communication.
    * MPU6050 accelerometer for G-force measurement.
    * Two physical buttons for screen navigation and backlight control.
    * TFT display (240x280) driven by TFT_eSPI.
* **Calibration:**
    * Accelerometer calibration routine at startup to define vehicle's horizontal axes based on gravity vector and sensor orientation.
* **PlatformIO Framework:** Developed using PlatformIO for managing dependencies and building the project.

## Hardware Requirements (from code)

* ESP32 microcontroller board (specific board seems to be one with a built-in NeoPixel on GPIO48, and specific pinouts for CAN, I2C, buttons, etc.)
* CAN Transceiver (e.g., TJA1050 or similar) connected to ESP32's CAN controller pins (GPIO4 for RX, GPIO5 for TX).
* MPU6050 Accelerometer connected via I2C (SDA on GPIO47, SCL on GPIO45).
* TFT Display (240x280 resolution, specific driver `TFT_eSPI`). The code mentions `TFT_BL` pin, likely for backlight control.
* Adafruit NeoPixel LED (or compatible single WS2812B) on GPIO48.
* Two push-buttons connected to GPIO12 and GPIO13 (with pull-up resistors, as `INPUT_PULLUP` is used).
* Buzzer/Piezo Speaker connected to GPIO21.

## Software & Libraries Used

* **Framework:** Arduino, compiled using PlatformIO.
* **Core Libraries:**
    * `Arduino.h`
    * `esp32_can.h` & `can_common.h`: For ESP32 CAN bus communication.
    * `esp32_obd2.h`: For OBD-II protocol handling.
    * `TFT_eSPI.h`: Driver for the TFT display.
    * `lvgl.h`: Light and Versatile Graphics Library for the UI.
    * `ui.h`: Custom UI components generated by SquareLine Studio (v1.4.0).
    * `Adafruit_NeoPixel.h`: For controlling the NeoPixel LED.
    * `Wire.h`: For I2C communication.
    * `Adafruit_Sensor.h` & `Adafruit_MPU6050.h`: For the MPU6050 accelerometer.
    * `math.h`: For mathematical functions (sqrt, fabsf).
* **RTOS:** Uses FreeRTOS tasks for handling buzzer alerts, OBD reading, and CAN connection management concurrently.

## Project Structure

* `src/obd-gauge-0.1.cpp`: Main application code.
* `lib/`: Contains local libraries or dependencies (if any, managed by PlatformIO).
* `ui/`: Contains the SquareLine Studio project (`esp32-obd-ver1.spj`) and exported UI files (`ui.c`, `ui.h`, assets).
* `platformio.ini`: PlatformIO project configuration file, defining dependencies and build environment.
* `.gitignore`: Specifies intentionally untracked files that Git should ignore.

## Setup & Installation

1.  **Clone the repository:**
    ```bash
    git clone [https://github.com/RomanBabakin/esp32-obd-ver1.git](https://github.com/RomanBabakin/esp32-obd-ver1.git)
    cd esp32-obd-ver1
    ```
2.  **PlatformIO:**
    * Ensure you have PlatformIO Core installed or use PlatformIO IDE for VSCode.
    * Open the project in PlatformIO.
    * PlatformIO should automatically install the necessary library dependencies defined in `platformio.ini`.
3.  **Hardware Connections:** Connect the ESP32, CAN transceiver, MPU6050, TFT display, NeoPixel, buttons, and buzzer according to the pin definitions in `obd-gauge-0.1.cpp`.
    * `CAN_RX_PIN`: GPIO4
    * `CAN_TX_PIN`: GPIO5
    * `WLED_PIN` (NeoPixel): GPIO48
    * `sda_pin` (I2C SDA for MPU6050): GPIO47
    * `scl_pin` (I2C SCL for MPU6050): GPIO45
    * `button_1_Pin`: GPIO12
    * `button_2_Pin`: GPIO13
    * `TONE_OUTPUT_PIN` (Buzzer): GPIO21
    * Ensure TFT display pins are correctly configured in your `TFT_eSPI/User_Setup.h` or via PlatformIO build flags if overriding.
4.  **Build and Upload:** Use PlatformIO to build and upload the firmware to your ESP32 board.

## How to Use

* **Power On:** Upon powering on, the device will initialize. The NeoPixel LED will indicate status:
    * Red: Startup.
    * Blue: Attempting to connect to the vehicle's CAN bus.
    * Green: Successfully connected to the CAN bus.
* **Calibration:** An accelerometer calibration routine runs automatically at startup. Ensure the device (and the car) is stationary and on a level surface during this phase for accurate G-force readings.
* **Screen Navigation:**
    * **Button 1 (GPIO12):** Cycles through the different display screens.
    * **Button 2 (GPIO13):** Currently used for manually incrementing some OBD values for testing/visualization purposes (this part of the code might be for debugging).
* **Display Screens:**
    * **Screen 1:** Coolant, Oil, and Intake Air Temperatures.
    * **Screen 2:** Boost Pressure.
    * **Screen 3:** Engine RPM.
    * **Screen 4:** G-Force Meter. Textual G-force values are displayed as absolute (always positive). The cursor direction indicates the actual G-force direction (lateral cursor inverted as per preference, longitudinal cursor inverted as per preference).
    * **Screen 5:** Calculated Gear indicator.
* **Alerts:** The buzzer will sound for high coolant or oil temperature conditions. Oil temperature alarm (`>= 120Â°C`) has the highest priority.

## Notes

* This project is a personal endeavor and work-in-progress.
* The OBD-II PID reading sequence in `obdRead()` is optimized for frequent RPM/Boost updates and less frequent temperature updates. A separate `obdClioRead()` function is present for Renault Clio specific PIDs (primarily for gear calculation which requires vehicle speed). To use with a Clio for gear display, the `obdReaderTask` needs to be modified to call `obdClioRead()`.
* The UI elements (screens, labels, gauges) are designed in SquareLine Studio 1.4.0, and the project file (`esp32-obd-ver1.spj`) is included in the `ui/` directory.
* The pin for TFT backlight (`TFT_BL`) is initialized in `setup()` but its control logic (e.g., turning on/off) via Button 1 in the `loop()` was commented out by the user in later versions of the provided source file during development.
* The current G-force meter calibration defines the car's horizontal forward and left axes based on the gravity vector and an assumed sensor Y-axis alignment during startup. The displayed G-forces are projections of the total measured acceleration onto these calibrated car axes.

## Disclaimer

This project involves interfacing with a vehicle's OBD-II system. Use at your own risk. Incorrect wiring or software may potentially interfere with vehicle systems. Ensure you understand the implications before connecting any custom hardware to your car.
